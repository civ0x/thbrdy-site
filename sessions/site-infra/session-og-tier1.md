# Session Prompt: Per-Essay OG Image Generation (Tier 1)

## Situation

thbrdy.dev has OG meta tag infrastructure in place (Base.astro accepts `image` prop, renders `og:image` + `twitter:image` with 1200×630 dimensions, `summary_large_image` card type). A default OG image exists at `public/images/og-default.png`, generated by `scripts/generate-og-image.js` using raw SVG → `@resvg/resvg-js`.

Currently, **every page shares the same default OG image**. When an essay is shared on Twitter, the card shows "THOMAS BRADY / TECHNO-VAJRAPĀṆI" — it doesn't identify which essay is being shared. This wastes the most valuable real estate in social sharing.

## Mission

Build a build-time OG image generation pipeline that produces a unique 1200×630 PNG for each published essay, using the site's typographic system. Update the content pipeline so each essay automatically gets its per-essay OG image in social cards.

## Deliverables

### 1. Upgrade `scripts/generate-og-image.js` → `scripts/generate-og-images.js`

Replace the single-image script with a pipeline that:

1. Reads all entries from the `writing` content collection (parse frontmatter from `src/content/writing/*.mdx`)
2. Skips drafts (`draft: true`)
3. For each essay, generates `/public/images/og/[slug].png` (1200×630)
4. Also regenerates the default image at `/public/images/og-default.png`

**Essay OG image layout (1200×630):**

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  [bg: #FAF6F0, subtle 1px border rgba(44,36,22,0.1)]        │
│                                                              │
│  ESSAY                          ← JetBrains Mono 13px,      │
│  ─────────────────────────        --accent (#B8860B),        │
│                                   uppercase, ls: 0.2em       │
│                                   + 1px rule --border-mid    │
│                                                              │
│  The Valley of Death            ← Cormorant Garamond 52px,  │
│  Is a Legibility Problem          600 weight, --text,        │
│                                   max 2 lines, word-wrap     │
│                                                              │
│  ── (40px gold rule, 2px)                                    │
│                                                              │
│  Making invisible structures    ← Cormorant Garamond 22px,  │
│  visible and navigable            italic, --text-light       │
│                                                              │
│                                                              │
│              thbrdy.dev         ← JetBrains Mono 14px,      │
│                                   --text-muted, centered     │
│                                   at bottom                  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

Margins: 80px left/right, 80px top, 60px bottom. Title block vertically centered in available space. The "ESSAY" label + rule mirrors the section-divider pattern from PostLayout.

**Font handling:**

The current script uses system fonts (Georgia, Courier New) as approximations. For the upgrade:

- Download TTF files for Cormorant Garamond (400, 500, 600, 400 italic) and JetBrains Mono (400) from Google Fonts
- Place in `scripts/fonts/` (gitignored or committed — your call, they're open-source fonts)
- Load into resvg via the `font` option: `{ fontFiles: ['scripts/fonts/CormorantGaramond-SemiBold.ttf', ...], loadSystemFonts: false }`
- Reference by `font-family` name in SVG text elements

**Title line-wrapping:**

SVG `<text>` doesn't auto-wrap. Implement manual word-wrapping:
- Split title into words
- Measure approximate width per character at 52px (Cormorant Garamond at 52px is roughly 26px per character — calibrate by testing)
- Break into lines that fit within (1200 - 160) = 1040px available width
- Render each line as a separate `<text>` element with appropriate `y` offset
- Maximum 2 lines. If title is too long, reduce font size to 44px and re-wrap
- Note: resvg doesn't expose text measurement. Use character-count heuristic, then verify visually

**Connected project indicator (optional):**

If the essay has `connected_project` in frontmatter, render it after the "ESSAY" label: `ESSAY · NOTICE` or `ESSAY · SCHOLION` in JetBrains Mono.

### 2. Wire essay-specific images into the content pipeline

**In `src/pages/writing/[...slug].astro`:**

Pass the essay-specific OG image path to PostLayout:

```astro
<PostLayout
  title={post.data.title}
  description={post.data.description}
  date={post.data.date}
  tags={post.data.tags}
  connected_project={post.data.connected_project}
  minutesRead={minutesRead}
  ogImage={`/images/og/${post.id}.png`}
>
```

**In `src/layouts/PostLayout.astro`:**

Accept `ogImage` prop and pass to Base:

```astro
const { title, description, date, tags, connected_project, minutesRead, ogImage } = Astro.props;
// ...
<Base title={`${title} — Thomas Brady`} description={description} type="article" image={ogImage}>
```

Update the `Props` interface accordingly.

### 3. Add npm script

In `package.json`, add:

```json
"scripts": {
  "generate:og": "node scripts/generate-og-images.js",
  "prebuild": "node scripts/generate-og-images.js"
}
```

The `prebuild` hook ensures OG images are always current before `npm run build`. The standalone `generate:og` script allows manual regeneration.

### 4. Directory structure

```
public/images/og/
├── og-default.png         (regenerated — replaces public/images/og-default.png)
├── ab-essay.png
├── notice.png
├── scholion.png
├── learned-compilation.png
├── coregulation.png
└── valley-of-death.png

scripts/
├── generate-og-images.js  (replaces generate-og-image.js)
└── fonts/
    ├── CormorantGaramond-SemiBold.ttf
    ├── CormorantGaramond-Italic.ttf
    └── JetBrainsMono-Regular.ttf
```

Move the default OG image from `public/images/og-default.png` to `public/images/og/og-default.png` and update the default path in `Base.astro` accordingly.

## Technical Constraints

- `@resvg/resvg-js` is already a devDependency — no new dependencies needed
- The script must parse MDX frontmatter (YAML between `---` delimiters). Use a simple regex or `js-yaml` (already a devDependency) to extract title, description, draft, connected_project
- Do NOT use Satori. Raw SVG string templates → resvg is simpler, has no font format constraints, and matches the existing pattern
- No changes to `astro.config.mjs` — this is a pre-build script, not an Astro integration
- Generated PNGs should be ≤50KB each (the default is 22KB — similar density expected)
- The old `scripts/generate-og-image.js` can be deleted after the new script is verified

## Verification Checklist

- [ ] `npm run generate:og` produces one PNG per non-draft essay in `public/images/og/`
- [ ] Each PNG is 1200×630 and visually matches the layout spec (title, gold rule, tagline, URL)
- [ ] Long titles (e.g., "The Valley of Death Is a Legibility Problem") wrap to 2 lines without overflow
- [ ] Default OG image still generates at `public/images/og/og-default.png`
- [ ] `Base.astro` default image path updated to `/images/og/og-default.png`
- [ ] Essay pages render `og:image` pointing to their specific image (inspect HTML source)
- [ ] Homepage and other non-essay pages still use the default OG image
- [ ] `npm run build` succeeds with zero errors
- [ ] Fonts render as Cormorant Garamond / JetBrains Mono (not system font fallbacks)
- [ ] Background is #FAF6F0, text is #2C2416, accent is #B8860B in all generated images
